PRINT @(-1):"MVDBTOOLKIT.TEST"
PRINT

INCLUDE MVDBTOOLKIT.BP.INCLUDE MVDBTOOLKIT.TEST.INCLUDE

TEST.PLATFORM=FIELD(CMND,' ',2)
TEST.MVTYPE=FIELD(CMND,' ',3)

IF TEST.PLATFORM = "" THEN
   PRINT "Enter Platform: ":; INPUT TEST.PLATFORM
END

IF TEST.MVTYPE = "" THEN
   PRINT "Enter MVType: ":; INPUT TEST.MVTYPE
END

IF TEST.PLATFORM='' OR TEST.MVTYPE='' THEN
    PRINT "Usage: MVDBTOOLKIT PLATFORM MVTYPE"
    PRINT
    PRINT "PLATFORM=WINDOWS or LINUX"
    PRINT "MVTYPE=JBASE,D3,UNIVERSE,UNIDATA"
    STOP
END

WOBJ.RTNE="MVDBTOOLKIT.WOBJ"

* GET ENVIRONMENT
CALL MVDBTOOLKIT.WPLATFORM(PLATFORM.OBJ)

CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","platform",PLATFORM,"",RERR)
TEST='platform'; GOSUB start.test
TEST.MSG=PLATFORM:"=":TEST.PLATFORM
IF PLATFORM # TEST.PLATFORM THEN TEST.STATUS=0 ELSE TEST.STATUS=1
GOSUB end.test

CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","mvtype",RESULT,"",RERR)


TEST='mvtype'; GOSUB start.test
TEST.MSG=RESULT:"=":TEST.MVTYPE
IF RESULT # TEST.MVTYPE THEN TEST.STATUS=0 ELSE TEST.STATUS=1
GOSUB end.test
CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","tmpdir",TMP.DIR,"",RERR)
CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","filedelim",FILEDELIM,"",RERR)

TEST='filedelim'; GOSUB start.test
CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","filedelim",FILEDELIM,"",RERR)
TEST.MSG=FILEDELIM
TEST.STATUS=1
BEGIN CASE
   CASE OCONV(PLATFORM,"MCU") = "LINUX" AND FILEDELIM="/"
   CASE OCONV(PLATFORM,"MCU") = "WINDOWS" AND FILEDELIM="\"
   CASE 1; TEST.STATUS=0
END CASE
GOSUB end.test

TEST='tmpdir'; GOSUB start.test
CALL @WOBJ.RTNE(PLATFORM.OBJ,"GET","tmpdir",TMP.DIR,"",RERR)
TEST.MSG=TMP.DIR
TEST.STATUS=1
IF TMP.DIR="" THEN TEST.STATUS=0
GOSUB end.test


TEST='MVDBTOOLKIT.SWAP'
GOSUB start.test
S='TEST LINE TEST LINE'
ORIG.STRING=S
CALL MVDBTOOLKIT.SWAP(S,"ES","XX")
IF S = "TXXT LINE TXXT LINE" THEN TEST.STATUS=1 ELSE TEST.STATUS=0
TEST.MSG=S
GOSUB end.test

* Test 1 Getenv

TEST="getenv"
GOSUB start.test
CALL MVDBTOOLKIT.WGETENV("PATH",PATH)
IF PATH # "" THEN
    TEST.MSG=PATH[1,60]
    TEST.STATUS=1
END ELSE
    TEST.MSG=""
    TEST.STATUS=0
END
GOSUB end.test

* Test WEXECUTE

TEST="wexecute"; GOSUB start.test
CMND='echo MVDBTOOLKIT.TEST'

CALL @WOBJ.RTNE(COBJ,"FROMSTRING","","{}","",RERR)
CALL @WOBJ.RTNE(COBJ,"SET","command",CMND,"",RERR)
CALL MVDBTOOLKIT.WEXECUTE(COBJ)
CALL @WOBJ.RTNE(COBJ,"GET","result.result",CMND.RESULT,"",RERR)

IF INDEX(CMND.RESULT,"MVDBTOOLKIT.TEST",1) THEN
    TEST.MSG=CMND.RESULT
    TEST.STATUS=1
END ELSE
    TEST.MSG=CMND.RESULT
    TEST.STATUS=0
END
CONVERT CHAR(13):CHAR(10) TO '' IN TEST.MSG
GOSUB end.test

* Test WFILEIO

TEST="WFILEIO-WRITE"

USER.NO=FIELD(OCONV('','U50BB'),' ',1)
GOSUB start.test
CALL @WOBJ.RTNE(FOBJ,"FROMSTRING","","{}","",RERR)
CALL @WOBJ.RTNE(FOBJ,"SET","action","WRITE","",RERR)
TMP.FILE.NAME=TMP.DIR:FILEDELIM:'TMP-':USER.NO:'.txt'
TEST.MSG=TMP.FILE.NAME

CALL @WOBJ.RTNE(FOBJ,"SET","path",TMP.FILE.NAME,"",RERR)
SAVE.FOBJ=FOBJ
TMP.DATA=TIMEDATE()
CALL @WOBJ.RTNE(FOBJ,"SET","data",TMP.DATA,"",RERR)
CALL MVDBTOOLKIT.WFILEIO(FOBJ)
CALL @WOBJ.RTNE(FOBJ,"GET","response.status",RESPONSE.STATUS,"",RERR)
CALL @WOBJ.RTNE(FOBJ,"GET","response.statusmsg",RESPONSE.STATUS.MSG,"",RERR)
TEST.STATUS=RESPONSE.STATUS
IF NOT(RESPONSE.STATUS) THEN TEST.MSG:=RESPONSE.STATUS.MSG
GOSUB end.test

IF NOT(TEST.STATUS) THEN STOP "Test Failed, no reason to continue"


TEST='WFILEIO-READ'
GOSUB start.test

* NOW READ IT BACK IN
CALL @WOBJ.RTNE(FOBJ,"SET","action","READ","",RERR)
CALL MVDBTOOLKIT.WFILEIO(FOBJ)
CALL @WOBJ.RTNE(FOBJ,"GET","response.data",RESPONSE.DATA,"",RERR)

TEST.MSG="(":TMP.DATA:')=(':RESPONSE.DATA:")"
TEST.STATUS=1
IF TMP.DATA # RESPONSE.DATA THEN TEST.STATUS=0
GOSUB end.test

TEST="WFILEIO-DELETE"; GOSUB start.test
FOBJ=SAVE.FOBJ
CALL @WOBJ.RTNE(FOBJ,"SET","action","DELETE","",RERR)
CALL MVDBTOOLKIT.WFILEIO(FOBJ)

FOBJ=SAVE.FOBJ
CALL @WOBJ.RTNE(FOBJ,"SET","action","READ","",RERR)
CALL MVDBTOOLKIT.WFILEIO(FOBJ)
RESPONSE.DATA=""

CALL @WOBJ.RTNE(FOBJ,"GET","response.data",RESPONSE.DATA,"",RERR)
CALL @WOBJ.RTNE(FOBJ,"GET","response.status",RESPONSE.STATUS,"",RERR)
CALL @WOBJ.RTNE(FOBJ,"GET","response.statusmsg",RESPONSE.STATUSMSG,"",RERR)
TEST.STATUS=1
TEST.MSG=TMP.FILE.NAME:' ':RESPONSE.STATUS
IF RESPONSE.STATUS=0 AND RESPONSE.DATA="" THEN NULL ELSE TEST.STATUS=0
GOSUB end.test

TEST="WCALL"
GOSUB start.test

CALL @WOBJ.RTNE(OBJ,"FROMSTRING","","{}","",RERR)

 CALL @WOBJ.RTNE(OBJ,"SET","method","POST","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","debug","Y","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","url","https://httpbin.org/anything?field1=value1","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","insecure","Y","",RERR)
 
 CALL @WOBJ.RTNE(OBJ,"SET.OBJECT","headers","{}","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","headers.X-TEST-HEADER","headertest","",RERR)
 
 CALL @WOBJ.RTNE(OBJ,"SET.ARRAY","formfields","[]","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET.OBJECT","formfields[-1]","{}","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","formfields[0].name","field2","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","formfields[0].value","VALUE2$","",RERR)

 CALL @WOBJ.RTNE(SOBJ,"FROMSTRING","","{}","",RERR)
 CALL @WOBJ.RTNE(SOBJ,"SET","name","field3","",RERR)
 CALL @WOBJ.RTNE(SOBJ,"SET","value","<EXAMPLE HTML>","",RERR)
 CALL @WOBJ.RTNE(SOBJ,"TOSTRING","",SJSON,"",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET.OBJECT","formfields[-1]",SJSON,"",RERR)

 CALL MVDBTOOLKIT.WCALL(OBJ)

 CALL @WOBJ.RTNE(OBJ,"GET","response.data",RESPONSE,"",RERR)
 OPEN "MVDBTOOLKIT.BP" TO FILE ELSE STOP
 *PRINT "RESPONSE=":RESPONSE
 WRITE RESPONSE ON FILE, "MVDBTOOLKIT.TEST.JSON"
 CALL @WOBJ.RTNE(OBJ,"TOSTRING","",OUT.JSON,"PRETTIFY",RERR)
 WRITE OUT.JSON ON FILE, "MVDBTOOLKIT.WCALL.JSON"

 
 CALL @WOBJ.RTNE(OBJ,"GET","response.status",RESPONSE.STATUS,"",RERR)
 *PRINT 'RESPONSE.STATUS=':RESPONSE.STATUS:'  ':
 *IF RESPONSE.STATUS="200" THEN PRINT "OK" ELSE PRINT "FAIL"
 TEST.MSG=RESPONSE.STATUS
 IF RESPONSE.STATUS="200" THEN
    TEST.STATUS=1
 END ELSE
    TEST.STATUS=0
 END
 GOSUB end.test

 GOSUB start.test
 TEST='WCALL.HTTPTYPE'
 CALL @WOBJ.RTNE(OBJ,"GET","response.http_type",RESPONSE.HTTP.TYPE,"",RERR)
 *PRINT 'RESPONSE.HTTP_TYPE=':RESPONSE.HTTP.TYPE
 TEST.MSG=RESPONSE.HTTP.TYPE
 IF TEST.MSG="HTTP/1.1" THEN
    TEST.STATUS=1
 END ELSE
    TEST.STATUS=0
 END
 GOSUB end.test
 CALL @WOBJ.RTNE(ROBJ,"FROMSTRING","",RESPONSE,"",RERR)

 TEST="WCALL.FIELD1"
 GOSUB start.test
 CALL @WOBJ.RTNE(ROBJ,"GET","args.field1",VALUE,"",RERR)
 TEST.MSG=VALUE
 IF TEST.MSG="value1" THEN TEST.STATUS=1 ELSE TEST.STATUS=0
 GOSUB end.test


TEST="WCALL.field2"
 GOSUB start.test
 CALL @WOBJ.RTNE(ROBJ,"GET","form.field2",VALUE,"",RERR)
 TEST.MSG=VALUE
 IF TEST.MSG="VALUE2$" THEN TEST.STATUS=1 ELSE TEST.STATUS=0
 GOSUB end.test

TEST="WCALL.field3"
 GOSUB start.test
 CALL @WOBJ.RTNE(ROBJ,"GET","form.field3",VALUE,"",RERR)
 TEST.MSG=VALUE
 IF TEST.MSG="<EXAMPLE HTML>" THEN TEST.STATUS=1 ELSE TEST.STATUS=0
 GOSUB end.test


 TEST="WCALL.HEADER"
 GOSUB start.test
 CALL @WOBJ.RTNE(ROBJ,"GET","headers.X-Test-Header",VALUE,"",RERR)
 TEST.MSG=VALUE
 IF TEST.MSG="headertest" THEN TEST.STATUS=1 ELSE TEST.STATUS=0
 GOSUB end.test

TEST="WCALL.BODY"
GOSUB start.test

CALL @WOBJ.RTNE(OBJ,"FROMSTRING","","{}","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","method","POST","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","debug","N","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","url","https://httpbin.org/anything?field1=value1","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","insecure","N","",RERR)

 CALL @WOBJ.RTNE(OBJ,"SET.OBJECT","headers","{}","",RERR)
 CALL @WOBJ.RTNE(OBJ,"SET","Content-Type","application/json","",RERR)
 
 CALL @WOBJ.RTNE(TESTOBJ,"FROMSTRING","","{}","",RERR)
 CALL @WOBJ.RTNE(TESTOBJ,"SET","test","value","",RERR)
 CALL @WOBJ.RTNE(TESTOBJ,"TOSTRING","",TESTJSON,"PRETTIFY",RERR)

 CALL @WOBJ.RTNE(OBJ,"SET.STRING","body",TESTJSON,"",RERR)
 
 CALL MVDBTOOLKIT.WCALL(OBJ)

 CALL @WOBJ.RTNE(OBJ,"GET","response.data",RESPONSE,"",RERR)
 
 WRITE RESPONSE ON FILE, "MVDBTOOLKIT.TESTBODY.JSON"
 CALL @WOBJ.RTNE(OBJ,"TOSTRING","",OUT.JSON,"PRETTIFY",RERR)
 WRITE OUT.JSON ON FILE, "MVDBTOOLKIT.WCALLBODY.JSON"


 CALL @WOBJ.RTNE(OBJ,"GET","response.status",RESPONSE.STATUS,"",RERR)
 *PRINT 'RESPONSE.STATUS=':RESPONSE.STATUS:'  ':
 *IF RESPONSE.STATUS="200" THEN PRINT "OK" ELSE PRINT "FAIL"
 TEST.MSG=RESPONSE.STATUS
 IF RESPONSE.STATUS="200" THEN
    TEST.STATUS=1
 END ELSE
    TEST.STATUS=0
 END
 GOSUB end.test

 TEST="WCALL.BODY.RESULT"
 GOSUB start.test
 * The testing web site does not send raw body back very well
 * we will just look for what we expect
 CONVERT CHAR(254):CHAR(253):CHAR(252):CHAR(10):CHAR(13) TO '' IN RESPONSE
 POS=INDEX(RESPONSE,'"form"',1)
 IF POS THEN RESPONSE=RESPONSE[POS,9999]
 TEST.MSG=RESPONSE
 IF INDEX(RESPONSE,'"test',1) AND INDEX(RESPONSE,'"value',1) THEN
     TEST.STATUS=1
 END ELSE
     TEST.STATUS=0
 END
 GOSUB end.test
 
STOP
*
GOSUB start.test
RETURN
*
process.error: *
IF RERR<1> THEN
   TEST.STATUS=-1
   TEST.MSG=RERR<1>
END
RETURN
*
*
start.test: *
TEST.STATUS=0
TEST.MSG="Success"
PRINT "":TEST[1,15]"L(#15)":
RETURN
*
end.test: *
PRINT "  ":TEST.MSG[1,50]"L(#50)":
PRINT " ":
IF TEST.STATUS THEN PRINT "[Ok    ]" ELSE PRINT @(-13):"[Failed]":@(-14)
RETURN


 
